@model List<Proyecto_Clinica_Universitaria.Models.ConsultaVistaModel>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="~/css/historialConsultasStyle.css" rel="stylesheet" />
}

<main class="p-4">
    <!-- Formulario oculto para el token antiforgery -->
    <form id="formAntiForgery" method="post" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <!-- Top form -->
    <div class="card-box ">
        <div class="row g-3 align-items-center">

            <div class="row">
                <!-- Historia Clínica -->
                <div class="shadow-lg p-3 col-md-4 mb-3 history-input rounded">
                    <i class="bi bi-journal-medical icon"></i>
                    <div class="text-end">1</div>
                    <hr class="my-2">
                    <div class="text-start">ESPECIALIDAD</div>
                </div>

                <!-- Botones -->
                <div class="d-flex justify-content-center col-md-4 ms-auto flex-wrap">
                    <button class="btn btn-dark d-flex align-items-center justify-content-center gap-2 px-3 m-2 flex-grow-1" style="min-width: 140px;">
                        <i class="bi bi-printer"></i>
                        <span class="d-none d-md-inline">IMPRIMIR</span>
                    </button>
                    <button class="btn btn-dark d-flex align-items-center justify-content-center gap-2 px-3 m-2 flex-grow-1" style="min-width: 140px;">
                        <i class="bi bi-file-earmark-excel"></i>
                        <span class="d-none d-md-inline">EXCEL</span>
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- Buscar -->
                <div class="col-md-5">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Buscar..." />
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="card-box table-responsive">
            <table class="table table-striped table-hover" id="consultasTable">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Cédula</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Temperatura</th>
                        <th>Pulso</th>
                        <th>Peso</th>
                        <th>Presión</th>
                        <th>SWAT O2</th>
                        <th>Médico</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var consulta in Model)
                        {
                            <tr data-id="@consulta.Codigo">
                                <td>@consulta.Fecha.ToString("dd/MM/yyyy")</td>
                                <td>@consulta.Cedula</td>
                                <td>@consulta.Nombre</td>
                                <td>@consulta.Apellido</td>
                                <td>@consulta.Temperatura</td>
                                <td>@consulta.Pulso</td>
                                <td>@consulta.Peso</td>
                                <td>@consulta.Presion</td>
                                <td>@consulta.SwatO2</td>
                                <td>@consulta.MedicoNombre</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="10" class="text-center">No hay consultas registradas.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</main>

<section class="d-flex justify-content-center gap-3 mt-4 p-3 bg-white rounded">
    <a asp-controller="Consultas" asp-action="Index" class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2" style="background-color:#880C09;">
        <i class="bi bi-plus-circle"></i>
        <span class="d-none d-md-inline">Nuevo</span>
    </a>
    <button id="btnEliminar" class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2" style="background-color:#880C09;" disabled>
        <i class="bi bi-trash"></i>
        <span class="d-none d-md-inline">Eliminar</span>
    </button>
    <button id="btnEditar" class="btn text-white px-3 py-2 d-flex align-items-center justify-content-center gap-2" style="background-color:#880C09;" disabled>
        <i class="bi bi-pencil-square"></i>
        <span class="d-none d-md-inline">Editar</span>
    </button>
</section>

@section Scripts {
    <script>
        let selectedRow = null;

        document.querySelectorAll('#consultasTable tbody tr').forEach(row => {
            row.addEventListener('click', () => {
                if (selectedRow) {
                    selectedRow.classList.remove('table-active');
                }
                if (selectedRow === row) {
                    selectedRow = null;
                    document.getElementById('btnEliminar').disabled = true;
                    document.getElementById('btnEditar').disabled = true;
                    return;
                }
                selectedRow = row;
                row.classList.add('table-active');
                document.getElementById('btnEliminar').disabled = false;
                document.getElementById('btnEditar').disabled = false;
            });
        });

        document.getElementById('btnEliminar').addEventListener('click', () => {
            if (!selectedRow) return;
            const id = selectedRow.getAttribute('data-id');
            const token = document.querySelector('#formAntiForgery input[name="__RequestVerificationToken"]').value;

            if (confirm("¿Seguro que deseas eliminar esta consulta?")) {
                fetch('/Consultas/Eliminar', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        '__RequestVerificationToken': token,
                        'codigo': id
                    })
                })
                .then(response => {
                    if (response.ok) {
                        selectedRow.remove();
                        selectedRow = null;
                        document.getElementById('btnEliminar').disabled = true;
                        document.getElementById('btnEditar').disabled = true;
                    } else {
                        alert("Error al eliminar la consulta.");
                    }
                })
                .catch(() => alert("Error de conexión con el servidor."));
            }
        });

        document.getElementById('btnEditar').addEventListener('click', () => {
            if (!selectedRow) return;
            const id = selectedRow.getAttribute('data-id');
            window.location.href = `/Consultas/Index?id=${id}`;
        });
    </script>
}


